<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ±ğŸ® Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            overflow-x: hidden;
        }

        .firebase-toast-red {
            position: fixed; top: 20px; right: 20px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: #fff; font-weight: 800;
            padding: 16px 20px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(220, 38, 38, 0.5);
            z-index: 999999; min-width: 300px;
            opacity: 0; transform: translateX(100px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .firebase-toast-red.show { opacity: 1; transform: translateX(0); }
        .firebase-toast-red .toast-title { font-size: 16px; margin-bottom: 6px; }
        .firebase-toast-red .toast-body { font-size: 14px; opacity: 0.95; }

        .hidden { display: none !important; }
        .btn { padding: 14px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #1a472a; color: #fff; }
        .btn-primary:hover { background: #2d5d3d; }
        .btn-google {
            background: #fff;
            color: #333;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
        }
        .btn-google:hover { background: #f8f8f8; }

        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: #161b22;
            border-radius: 12px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon { font-size: 60px; margin-bottom: 10px; }
        .logo-title { font-size: 24px; font-weight: bold; color: #1a472a; margin-bottom: 5px; }
        .logo-subtitle { font-size: 14px; color: #8b949e; }

        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 12px; font-weight: bold; color: #c9d1d9; margin-bottom: 8px; display: block; }
        .form-input {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 13px;
        }
        .form-input:focus { outline: none; border-color: #1a472a; }

        .user-badge {
            background: #1a472a;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #main-interface { display: none; padding: 40px 20px; }
        .dashboard { max-width: 1200px; margin: 0 auto; }
        .dashboard-title { font-size: 28px; font-weight: bold; color: #1a472a; margin-bottom: 30px; text-align: center; }
        
        .section-card {
            background: linear-gradient(135deg, #2d5016 0%, #1a472a 100%);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .section-card:hover { transform: translateY(-5px); box-shadow: 0 8px 32px rgba(45, 80, 22, 0.4); }
        .section-icon { font-size: 60px; margin-bottom: 15px; }
        .section-title { font-size: 24px; font-weight: bold; color: white; }

        .players-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .player-card {
            background: #161b22;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .player-card-stripe { height: 5px; background: #238636; }
        .player-card-content { padding: 20px; }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-info h3 {
            font-size: 18px;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .player-table-badge {
            display: inline-block;
            background: #238636;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .countdown-box {
            background: linear-gradient(135deg, #d4af37 0%, #f0c14b 100%);
            color: #000;
            font-size: 20px;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }

        .countdown-expired {
            background: linear-gradient(135deg, #da3633 0%, #f85149 100%);
            color: white;
        }

        .btn-end {
            background: #da3633;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-end:hover { background: #f85149; }

        .btn-back {
            background: #6e7681;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .btn-back:hover { background: #8b949e; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #161b22;
            border-radius: 12px;
        }
        .empty-icon { font-size: 60px; color: #30363d; margin-bottom: 20px; }
        .empty-text { font-size: 18px; color: #8b949e; }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen">
        <div class="login-card">
            <div class="logo-section">
                <div class="logo-icon">ğŸ“</div>
                <div class="logo-title">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø±</div>
                <div class="logo-subtitle">ğŸ±ğŸ® Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ§Ù„Ø©</div>
            </div>

            <div id="google-signin-area">
                <button class="btn btn-google" onclick="signInWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                    </svg>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Gmail
                </button>
            </div>

            <div id="user-info-display" class="hidden">
                <div class="user-badge">
                    <img id="user-avatar" class="user-avatar" src="" alt="User">
                    <div>
                        <div id="user-name-display" style="font-weight: bold;"></div>
                        <div id="user-email-display" style="font-size: 12px; opacity: 0.8;"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="enterSystem()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… â†</button>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="main-interface">
        <div class="dashboard">
            <h1 class="dashboard-title">ğŸ±ğŸ® Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="welcome-name"></span></h1>
            
            <div id="main-menu">
                <div class="section-card" onclick="openSection('billiard')">
                    <div class="section-icon">ğŸ±</div>
                    <h2 class="section-title">ØµØ§Ù„Ø© Ø§Ù„Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ</h2>
                </div>

                <div class="section-card" onclick="openSection('ps')" style="background: linear-gradient(135deg, #1f6feb 0%, #1a5bd8 100%);">
                    <div class="section-icon">ğŸ®</div>
                    <h2 class="section-title">ØµØ§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†</h2>
                </div>
            </div>

            <div id="section-view" class="hidden"></div>
        </div>
    </div>

    <script>
        // ========================================
        // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // ========================================
        const APP_DATA = {
            currentUser: null,
            billiard: { activePlayers: [], completedSessions: [], hourlyRate: 5000 },
            ps: { activePlayers: [], completedSessions: [], hourlyRate: 7000 },
            notifications: []
        };

        let currentMode = null;
        const countdownIntervals = {};

        // ========================================
        // 2. Google Sign-In
        // ========================================
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            
            script.onload = () => {
                google.accounts.id.initialize({
                    client_id: '152994650455-26obvvupjseuf62eb52il44g4pcc965i.apps.googleusercontent.com',
                    callback: handleGoogleSignIn
                });
            };
        }

        function signInWithGoogle() {
            google.accounts.id.prompt();
        }

        function handleGoogleSignIn(response) {
            const userData = parseJwt(response.credential);
            
            APP_DATA.currentUser = {
                email: userData.email,
                name: userData.name,
                picture: userData.picture,
                sub: userData.sub // Google User ID
            };

            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('user-avatar').src = userData.picture;
            document.getElementById('user-name-display').textContent = userData.name;
            document.getElementById('user-email-display').textContent = userData.email;
            
            document.getElementById('google-signin-area').classList.add('hidden');
            document.getElementById('user-info-display').classList.remove('hidden');

            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            loadUserData();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(window.atob(base64));
        }

        function enterSystem() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
            document.getElementById('welcome-name').textContent = APP_DATA.currentUser.name;
        }

        // ========================================
        // 3. Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€ Gmail
        // ========================================
        function getUserStorageKey() {
            if (!APP_DATA.currentUser) return 'billiard_guest';
            return 'billiard_' + APP_DATA.currentUser.sub;
        }

        function saveUserData() {
            try {
                const data = {
                    billiard: APP_DATA.billiard,
                    ps: APP_DATA.ps,
                    notifications: APP_DATA.notifications
                };
                localStorage.setItem(getUserStorageKey(), JSON.stringify(data));
                console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€:', APP_DATA.currentUser.email);
            } catch(e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', e);
            }
        }

        function loadUserData() {
            try {
                const saved = localStorage.getItem(getUserStorageKey());
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.billiard) APP_DATA.billiard = data.billiard;
                    if (data.ps) APP_DATA.ps = data.ps;
                    if (data.notifications) APP_DATA.notifications = data.notifications;
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€:', APP_DATA.currentUser.email);
                }
            } catch(e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', e);
            }
        }

        // ========================================
        // 4. ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
        // ========================================
        function openSection(mode) {
            currentMode = mode;
            document.getElementById('main-menu').classList.add('hidden');
            const sectionView = document.getElementById('section-view');
            sectionView.classList.remove('hidden');
            showActivePlayers();
        }

        function backToMain() {
            Object.keys(countdownIntervals).forEach(key => {
                clearInterval(countdownIntervals[key]);
                delete countdownIntervals[key];
            });
            
            document.getElementById('section-view').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            currentMode = null;
        }

        // ========================================
        // 5. Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        // ========================================
        function showActivePlayers() {
            const players = APP_DATA[currentMode].activePlayers;
            const icon = currentMode === 'billiard' ? 'ğŸ±' : 'ğŸ®';
            const title = currentMode === 'billiard' ? 'Ø§Ù„Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ' : 'Ø§Ù„Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†';
            const deviceLabel = currentMode === 'billiard' ? 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Ø§Ù„Ø¬Ù‡Ø§Ø²';
            
            const sectionView = document.getElementById('section-view');
            
            if (players.length === 0) {
                sectionView.innerHTML = `
                    <button class="btn-back" onclick="backToMain()">â† Ø±Ø¬ÙˆØ¹</button>
                    <h2 style="font-size: 24px; color: #c9d1d9; margin-bottom: 20px;">
                        ${icon} Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (0) - ${title}
                    </h2>
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¥</div>
                        <div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                    </div>
                `;
                return;
            }
            
            let playersHTML = players.map(player => createPlayerCard(player, deviceLabel)).join('');
            
            sectionView.innerHTML = `
                <button class="btn-back" onclick="backToMain()">â† Ø±Ø¬ÙˆØ¹</button>
                <h2 style="font-size: 24px; color: #c9d1d9; margin-bottom: 20px;">
                    ${icon} Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (${players.length}) - ${title}
                </h2>
                <div class="players-container">
                    ${playersHTML}
                </div>
            `;
            
            players.forEach(player => startCountdown(player));
        }

        function createPlayerCard(player, deviceLabel) {
            const remainingMins = Math.floor(player.remaining / 60);
            const remainingSecs = player.remaining % 60;
            const countdownClass = player.remaining <= 0 ? 'countdown-expired' : '';
            
            return `
                <div class="player-card">
                    <div class="player-card-stripe"></div>
                    <div class="player-card-content">
                        <div class="player-header">
                            <div class="player-info">
                                <h3>ğŸ‘¤ ${player.name}</h3>
                                <span class="player-table-badge">${deviceLabel} ${player.tableNumber}</span>
                            </div>
                            <button class="btn-end" onclick="endSession(${player.id})">Ø¥Ù†Ù‡Ø§Ø¡</button>
                        </div>
                        <div class="countdown-box ${countdownClass}" id="countdown-${player.id}">
                            â³ ${remainingMins.toString().padStart(2, '0')}:${remainingSecs.toString().padStart(2, '0')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========================================
        // 6. Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        // ========================================
        function startCountdown(player) {
            if (countdownIntervals[player.id]) {
                clearInterval(countdownIntervals[player.id]);
            }
            
            countdownIntervals[player.id] = setInterval(() => {
                const elem = document.getElementById(`countdown-${player.id}`);
                if (!elem) {
                    clearInterval(countdownIntervals[player.id]);
                    return;
                }
                
                player.remaining = Math.max(0, player.remaining - 1);
                
                const mins = Math.floor(player.remaining / 60);
                const secs = player.remaining % 60;
                
                elem.textContent = `â³ ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (player.remaining === 0) {
                    elem.classList.add('countdown-expired');
                    if (!player.timeFinishedAlerted) {
                        player.timeFinishedAlerted = true;
                        alert(`â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª ${player.name}`);
                    }
                    clearInterval(countdownIntervals[player.id]);
                }
                
                saveUserData();
            }, 1000);
        }

        // ========================================
        // 7. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
        // ========================================
        function endSession(playerId) {
            const player = APP_DATA[currentMode].activePlayers.find(p => p.id === playerId);
            if (!player) return;
            
            const endTime = Date.now();
            const duration = Math.floor((endTime - player.startTime) / 1000);
            const cost = Math.floor(duration / 3600 * player.customRate);
            
            APP_DATA[currentMode].completedSessions.push({
                id: endTime,
                name: player.name,
                tableNumber: player.tableNumber,
                startTime: player.startTime,
                endTime: endTime,
                cost: cost
            });
            
            APP_DATA[currentMode].activePlayers = APP_DATA[currentMode].activePlayers.filter(p => p.id !== playerId);
            
            if (countdownIntervals[playerId]) {
                clearInterval(countdownIntervals[playerId]);
                delete countdownIntervals[playerId];
            }
            
            saveUserData();
            alert(`âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©\nØ§Ù„Ù…Ø¨Ù„Øº: ${cost.toLocaleString()} Ø¯.Ø¹`);
            showActivePlayers();
        }

        // ========================================
        // 8. Firebase + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­)
        // ========================================
        window.addPlayerToSystem = function(payload, tableId) {
            if (!APP_DATA.currentUser) {
                console.error('âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const gameType = (payload.gameType || '').toLowerCase();
            const mode = gameType.includes('ps') || gameType.includes('play') ? 'ps' : 'billiard';
            const name = payload.playerName || payload.name || 'Ù„Ø§Ø¹Ø¨';
            const table = tableId || payload.tableId || '1';
            const count = Number(payload.count || 1);
            const minutes = Number(payload.minutes || (count * 10));
            const rate = Number(payload.pricePerGame || payload.total || 
                (APP_DATA[mode]?.hourlyRate || (mode === 'ps' ? 7000 : 5000)));

            const player = {
                id: Date.now(),
                name,
                tableNumber: table,
                startTime: Date.now(),
                customRate: rate,
                notes: `ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ â€¢ ${payload.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'Ù…ÙØ±Ø¯'} â€¢ ${count} ÙƒÙŠÙ…`,
                remaining: Math.max(0, minutes) * 60,
                initialMinutes: Math.max(1, minutes),
                overtimeAlerted: false,
                timeFinishedAlerted: false
            };

            if (!APP_DATA[mode]) {
                APP_DATA[mode] = {
                    activePlayers: [],
                    completedSessions: [],
                    hourlyRate: mode === 'ps' ? 7000 : 5000
                };
            }
            APP_DATA[mode].activePlayers = APP_DATA[mode].activePlayers || [];
            APP_DATA[mode].activePlayers.push(player);
            
            console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${name} Ù„Ù„Ù‚Ø³Ù…: ${mode}`);
            saveUserData();

            setTimeout(() => {
                if (typeof startCountdown === 'function') startCountdown(player);
                if (currentMode === mode) {
                    const sectionView = document.getElementById('section-view');
                    if (sectionView && !sectionView.classList.contains('hidden')) {
                        showActivePlayers();
                    }
                }
            }, 200);
        };

        // ========================================
        // 9. ØªØ­Ù…ÙŠÙ„ Google API Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        // ========================================
        window.addEventListener('load', () => {
            loadGoogleAPI();
        });
    </script>

    <!-- Firebase Listener -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onChildAdded, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC9Y_FW-ULjOD5F7U-WBV7aBMNvEyKAhfg",
            authDomain: "billiard-system.firebaseapp.com",
            databaseURL: "https://billiard-system-default-rtdb.firebaseio.com/",
            projectId: "billiard-system",
            storageBucket: "billiard-system.appspot.com",
            messagingSenderId: "152994650455",
            appId: "1:152994650455:web:1a68b2cd713b11a9cc612"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const PROCESSED_KEY = 'firebase_processed_v1';
        function getProcessed() {
            try { return new Set(JSON.parse(localStorage.getItem(PROCESSED_KEY) || '[]')); }
            catch { return new Set(); }
        }
        function addProcessed(key) {
            const set = getProcessed();
            set.add(key);
            localStorage.setItem(PROCESSED_KEY, JSON.stringify(Array.from(set).slice(-1000)));
        }

        function showRedToast(title, body) {
            const t = document.createElement('div');
            t.className = 'firebase-toast-red';
            t.innerHTML = `<div class="toast-title">${title}</div><div class="toast-body">${body}</div>`;
            document.body.appendChild(t);
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => {
                t.classList.remove('show');
                setTimeout(() => t.remove(), 400);
            }, 6000);
        }

        function playBeep() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioCtx();
                const now = ctx.currentTime;
                function tone(freq, start, dur, vol = 0.3) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = "square";
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now + start);
                    gain.gain.linearRampToValueAtTime(vol, now + start + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + start + dur);
                    osc.connect(gain).connect(ctx.destination);
                    osc.start(now + start);
                    osc.stop(now + start + dur + 0.05);
                }
                tone(880, 0, 0.2, 0.4);
                tone(1100, 0.25, 0.25, 0.35);
            } catch (e) {}
        }

        const allTables = ['b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'ps1', 'ps2', 'ps3', 'ps4'];

        async function attachTableListener(tableId) {
            const tableRegsRef = ref(db, `registrations/${tableId}`);
            try {
                const snap = await get(tableRegsRef);
                if (snap.exists()) {
                    snap.forEach(child => addProcessed(`${tableId}_${child.key}`));
                }

                onChildAdded(tableRegsRef, (childSnap) => {
                    const key = childSnap.key;
                    const fullKey = `${tableId}_${key}`;
                    if (getProcessed().has(fullKey)) return;
                    addProcessed(fullKey);

                    const data = childSnap.val() || {};
                    const name = data.playerName || data.name || 'Ù„Ø§Ø¹Ø¨';
                    const gameType = data.gameType === 'ps' ? 'Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†' : 'Ø¨Ù„ÙŠØ§Ø±Ø¯';
                    const mode = data.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'Ù…ÙØ±Ø¯';
                    const count = data.count || 1;

                    console.log('ğŸ”” ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:', { name, tableId, gameType });

                    showRedToast('ğŸ”” ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯', 
                        `${name} â€¢ ${tableId.toUpperCase()} â€¢ ${gameType} ${mode} â€¢ ${count} ÙƒÙŠÙ…`);
                    playBeep();
                    
                    if (typeof window.addPlayerToSystem === 'function') {
                        window.addPlayerToSystem(data, tableId);
                    }
                });

                console.log(`âœ… Ù…Ø³ØªÙ…Ø¹ Firebase Ù…ÙØ¹Ù‘Ù„: ${tableId}`);
            } catch (e) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ${tableId}:`, e);
            }
        }

        allTables.forEach(attachTableListener);
        console.log('âœ… Ù†Ø¸Ø§Ù… Firebase Ù…ÙØ¹Ù‘Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª');
    </script>
</body>
</html>
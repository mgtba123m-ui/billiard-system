<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ â€” ØµØ§Ù„Ø© Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #0b0f14;
            --card: #0f141b;
            --muted: #8ba3b4;
            --accent: #00c2ff;
            --accent-2: #ffd166;
            --good: #2bd97a;
            --warn: #ffae00;
            --bad: #ff5c6b;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 1200px at 70% -200px, #14202c 0%, #0b0f14 50%, #0b0f14 100%);
            color: #eaf6ff;
            font-family: "Tajawal",system-ui,Segoe UI,Arial,sans-serif;
        }

        .wrap {
            max-width: 1120px;
            margin: 32px auto;
            padding: 16px
        }

        .header {
            background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .title {
            font-weight: 800;
            font-size: 22px;
            display: flex;
            gap: 10px;
            align-items: center
        }

            .title .cap {
                font-size: 26px
            }

        .sub {
            color: var(--muted);
            font-weight: 600
        }

        .grid {
            display: grid;
            gap: 16px;
            margin-top: 16px
        }

        @media(min-width:920px) {
            .grid {
                grid-template-columns: 1fr 1fr
            }
        }

        .card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.25)
        }

            .card h3 {
                margin: 0 0 12px 0;
                font-size: 18px
            }

        .hint {
            color: var(--muted);
            font-size: 14px
        }

        .row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
            margin: 8px 0
        }

            .row.full {
                grid-template-columns: 1fr
            }

        .input, select {
            background: #0c1218;
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 10px;
            color: #eaf6ff;
            padding: 12px;
            font-size: 16px;
            outline: none
        }

        select {
            appearance: none
        }

        .badge {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 14px
        }

        .busy {
            background: #201113;
            border: 1px solid rgba(255,0,60,.35);
            color: #ffd8de
        }

        .free {
            background: #102418;
            border: 1px solid rgba(0,255,120,.25);
            color: #b8ffdc
        }

        .sum {
            background: linear-gradient(180deg, #0f151c, #0a0e12);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px;
            padding: 16px;
            margin-top: 10px
        }

            .sum .big {
                font-size: 28px;
                font-weight: 900;
                color: var(--accent-2)
            }

        .btns {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            transition: .2s
        }

            .btn:disabled {
                opacity: .55;
                cursor: not-allowed
            }

        .btn-main {
            background: linear-gradient(90deg, #00c2ff, #35e3ff);
            color: #001019
        }

        .btn-ghost {
            background: #0c1218;
            border: 1px solid rgba(255,255,255,.12);
            color: #cfe9ff
        }

        .note {
            margin-top: 10px;
            font-size: 14px;
            color: var(--muted)
        }

        .footer {
            margin-top: 18px;
            color: #9ac7ff66;
            text-align: center;
            font-weight: 600
        }

        .gold {
            color: #ffd166
        }

        .muted {
            color: var(--muted)
        }

        .bar {
            height: 6px;
            border-radius: 6px;
            background: linear-gradient(90deg,#00c2ff,#62f2ff);
            opacity: .25;
            margin: 10px 0
        }

        .ok {
            color: var(--good)
        }

        .warn {
            color: var(--warn)
        }

        .bad {
            color: var(--bad)
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="header">
            <div>
                <div class="title"><span class="cap">ğŸ“</span> Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø± <span class="muted">| Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</span></div>
                <div class="sub">Billiard + PlayStation â€” Professional Edition â€¢ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±: <span class="gold">Mujtaba Al-Dafaâ€™i</span></div>
            </div>
            <div id="tableStatus" class="badge free">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªØ§Ø­Ø©</div>
        </div>

        <div class="grid">
            <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
            <div class="card">
                <h3>Ø£Ø³Ø¹Ø§Ø± Ø³Ø±ÙŠØ¹Ø©</h3>
                <div class="bar"></div>
                <div class="hint">ÙƒÙ„ ÙƒÙŠÙ… = 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø¨Ù„ÙŠ/Ø³ØªÙŠØ´Ù†)</div>
                <div class="row"><div>Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ Ø¹Ø§Ø¯ÙŠ</div><div>1000 Ø¯.Ø¹</div></div>
                <div class="row"><div>Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ Ø²ÙˆØ¬ÙŠ</div><div>1500 Ø¯.Ø¹</div></div>
                <div class="row"><div>ÙƒÙ„Ø±Ø§Øª  Ù…ÙØ±Ø¯</div><div>1500 Ø¯.Ø¹</div></div>
                <div class="row"><div>ÙƒÙ„Ø±Ø§Øª Ø²ÙˆØ¬ÙŠ</div><div>3000 Ø¯.Ø¹</div></div


                <div class="sum">
                    <div class="muted">Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</div>
                    <div class="hint">Ù„Ø§ØªØ­Ø§ÙˆÙ„ ØªÙ„Ø¹Ø¨ Ø¨Ø°ÙŠÙ„Ùƒ ÙˆØªØ®Ø±Ø¨ ÙƒÙˆØ¯ ØªØ±Ø§ ÙƒÙ„Ø´ÙŠØ¡ ÙŠØ±Ø³Ù„ Ù„Ù„Ù†Ø¸Ø§Ù….</div>
                </div>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
            <div class="card">
                <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
                <div class="bar"></div>
                <div class="row">
                    <div>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</div>
                    <div><input id="playerName" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" /></div>
                </div>
                <div class="row">
                    <div>Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ®</div>
                    <div>
                        <select id="gameType" class="input">
                            <option value="billiard">Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ</option>
                            <option value="ps">Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div>Ù†ÙˆØ¹ Ø§Ù„ÙƒÙÙŠÙ… ğŸ”–</div>
                    <div>
                        <select id="mode" class="input">
                            <option value="single">Ù…ÙØ±Ø¯</option>
                            <option value="double">Ø²ÙˆØ¬ÙŠ</option>
                            <option value="double">ÙƒÙ„Ø±Ø§Øª Ù…ÙØ±Ø¯</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ…Ø§Øª #ï¸âƒ£</div>
                    <div>
                        <select id="gamesCount" class="input">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>

                <div class="sum" id="sumBox">
                    <div class="muted">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                    <div class="big" id="totalText">â€”</div>
                    <div class="hint" id="durationText">â€”</div>
                </div>

                <div class="btns">
                    <button id="btnRegister" class="btn btn-main">ØªØ³Ø¬ÙŠÙ„</button>
                    <button id="btnClear" class="btn btn-ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
                </div>

                <div class="note" id="stateNote">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„â€¦</div>
            </div>
        </div>

        <div class="footer">Â© 2025 â€¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ â€” Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø± â€¢ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±: <span class="gold">Mujtaba Al-Dafaâ€™i</span></div>
    </div>

    <!-- Firebase + Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© -->
    <script type="module">
        // ================ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ) ================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue, onChildAdded, set, update, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC9Y_FW-ULjOD5F7U-WBV7aBMNvEyKAhfg",
            authDomain: "billiard-system.firebaseapp.com",
            databaseURL: "https://billiard-system-default-rtdb.firebaseio.com/",
            projectId: "billiard-system",
            storageBucket: "billiard-system.appspot.com",
            messagingSenderId: "152994650455",
            appId: "1:152994650455:web:1a668b2cd713b11a9cc612"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================ Ø«Ø§Ø¨Øª Ø²Ù…Ù† Ø§Ù„ÙƒÙŠÙ… ================
        const MINUTES_PER_GAME = 10; // Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
        const now = () => Date.now();

        // ================ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ================
        const $ = (q) => document.querySelector(q);
        const params = new URLSearchParams(location.search);
        const tableId = (params.get("table") || "b1").toLowerCase(); // b1..b6
        const role = (params.get("role") || "").toLowerCase();    // manager = Ù†Ø§Ø·Ù‚

        // Ø¹Ù†Ø§ØµØ±
        const playerNameEl = $("#playerName");
        const gameTypeEl = $("#gameType");
        const modeEl = $("#mode");
        const gamesEl = $("#gamesCount");
        const totalText = $("#totalText");
        const durationText = $("#durationText");
        const btnRegister = $("#btnRegister");
        const btnClear = $("#btnClear");
        const tableBadge = $("#tableStatus");
        const stateNote = $("#stateNote");

        // ================ ØªØ³Ø¹ÙŠØ± Ø¨Ø³ÙŠØ· ================
        function getPrice(gameType, mode) {
            // Ø¨Ù„ÙŠØ§Ø±Ø¯Ùˆ: Ø¹Ø§Ø¯ÙŠ 1000 - Ø²ÙˆØ¬ÙŠ 1500
            // Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†: Ù…ÙØ±Ø¯ 1000 - Ø²ÙˆØ¬ÙŠ 2000
            if (gameType === "billiard") {
                return mode === "double" ? 1500 : 1000;
            } else {
                return mode === "double" ? 2000 :1000;
            }
        }
        function refreshSummary() {
            const gameType = gameTypeEl.value;
            const mode = modeEl.value;
            const count = +gamesEl.value;
            const price = getPrice(gameType, mode);
            const total = price * count;
            const minutes = count * MINUTES_PER_GAME;

            totalText.textContent = `${total.toLocaleString()} Ø¯.Ø¹`;
            durationText.textContent = `Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© â€¢ Ø§Ù„Ø³Ø¹Ø±/ÙƒÙŠÙ…: ${price.toLocaleString()} Ø¯.Ø¹`;
        }
        ["change", "input"].forEach(ev => {
            [gameTypeEl, modeEl, gamesEl].forEach(el => el.addEventListener(ev, refreshSummary));
        });
        refreshSummary();

        // ================ Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================
        const tableRef = ref(db, `tables/${tableId}`);              // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (busy/busyUntil/â€¦)
        const regsRef = ref(db, `registrations/${tableId}`);       // Ø³Ø¬Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©

        // ================ Ø¹Ø¯Ù‘Ø§Ø¯ Ùˆ Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ================
        let busyUntil = 0;
        let timer = null;

        function speak(msg) {
            if (role !== "manager") return; // Ù…Ø§ ÙŠÙ†Ø·Ù‚ Ø¥Ù„Ø§ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
            try {
                const u = new SpeechSynthesisUtterance(msg);
                u.lang = "ar"; u.rate = 1; u.pitch = 1; u.volume = 1;
                speechSynthesis.cancel();
                speechSynthesis.speak(u);
            } catch { }
        }

        function setBusyUI(isBusy, untilTs) {
            if (isBusy) {
                tableBadge.classList.remove("free"); tableBadge.classList.add("busy");
                tableBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø´ØºÙˆÙ„Ø©";
                btnRegister.disabled = true;
                countdown(untilTs);
                stateNote.innerHTML = `<span class="warn">â³ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø´ØºÙˆÙ„Ø©</span> â€” ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª.`;
            } else {
                tableBadge.classList.remove("busy"); tableBadge.classList.add("free");
                tableBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªØ§Ø­Ø©";
                btnRegister.disabled = false;
                stateNote.innerHTML = `Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„â€¦`;
                if (timer) { clearInterval(timer); timer = null; }
            }
        }

        function countdown(untilTs) {
            if (timer) { clearInterval(timer); }
            const tick = () => {
                const remain = Math.max(0, untilTs - now());
                if (remain <= 0) {
                    clearInterval(timer); timer = null;
                    // Ø³ÙŠØªØ¨Ø¯Ù‘Ù„ Ø¥Ù„Ù‰ Ù…ØªØ§Ø­Ø© Ø¹Ø¨Ø± Ù…Ø³ØªÙ…Ø¹ onValue Ø£Ø¯Ù†Ø§Ù‡
                    return;
                }
                const s = Math.ceil(remain / 1000);
                const m = Math.floor(s / 60), ss = String(s % 60).padStart(2, "0");
                stateNote.innerHTML = `â³ Ù…Ø´ØºÙˆÙ„Ø© â€” ÙŠØªØ§Ø­ Ø¨Ø¹Ø¯ <b>${m}:${ss}</b>`;
            };
            tick();
            timer = setInterval(tick, 1000);
        }

        // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø­Ø¸ÙŠÙ‹Ø§
        onValue(tableRef, (snap) => {
            const v = snap.val() || {};
            busyUntil = v.busyUntil || 0;
            const isBusy = busyUntil > now();
            setBusyUI(isBusy, busyUntil);

            // Ù†Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ù…ØªØ§Ø­Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±)
            if (!isBusy && role === "manager" && v.lastEndedAt) {
                speak(`Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© ${v.lastPlayerName ? "Ù„Ù„Ø§Ø¹Ø¨ " + v.lastPlayerName : ""} Ø¹Ù„Ù‰ Ø·Ø§ÙˆÙ„Ø© ${tableId.replace("b", "Ø¨ÙŠ")}. Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†.`);
            }
        });

        // ================ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ ================
        async function register() {
            const playerName = (playerNameEl.value || "").trim();
            const gameType = gameTypeEl.value;
            const mode = modeEl.value;
            const count = +gamesEl.value;

            if (!playerName) { playerNameEl.focus(); return; }

            // Ù…Ù†Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø´ØºØ§Ù„
            const tblSnap = await get(tableRef);
            const tv = tblSnap.val() || {};
            if ((tv.busyUntil || 0) > now()) {
                stateNote.innerHTML = `<span class="bad">âš ï¸ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø´ØºÙˆÙ„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</span>`;
                return;
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙˆÙ‚Øª
            const price = getPrice(gameType, mode);
            const total = price * count;
            const minutes = count * MINUTES_PER_GAME;
            const until = now() + minutes * 60 * 1000;

            // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨
            const entry = {
                tableId, playerName, gameType, mode, count,
                pricePerGame: price, total, minutes,
                createdAt: serverTimestamp()
            };
            const key = push(regsRef).key;
            await set(ref(db, `registrations/${tableId}/${key}`), entry);

            // Ù‚ÙÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
            await update(tableRef, {
                busy: true,
                busyUntil: until,
                lastPlayerName: playerName,
                lastStartedAt: serverTimestamp(),
                lastEndedAt: null
            });

            stateNote.innerHTML = `<span class="ok">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</span> â€” Ø§Ù„Ù…Ø¯Ø©: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©.`;
        }

        // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ÙˆÙ‚Øª (watcher Ø®ÙÙŠÙ)
        setInterval(async () => {
            const snap = await get(tableRef);
            const v = snap.val() || {};
            if ((v.busyUntil || 0) > 0 && v.busyUntil <= now()) {
                await update(tableRef, {
                    busy: false,
                    busyUntil: 0,
                    lastEndedAt: serverTimestamp()
                });
            }
        }, 15_000); // ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ© ÙƒÙØ§ÙŠØ©

        // Ø£Ø²Ø±Ø§Ø±
        btnRegister.addEventListener("click", register);
        btnClear.addEventListener("click", () => {
            playerNameEl.value = ""; gameTypeEl.value = "billiard"; modeEl.value = "single"; gamesEl.value = "1";
            refreshSummary();
        });

        // Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        document.title = `Ø·Ø§ÙˆÙ„Ø© ${tableId.toUpperCase()} â€” Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ`;
    </script>
</body>
</html>